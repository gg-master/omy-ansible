---
- name: Configure hosts security
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Configure sudoers (NOPASSWD, disable admin, remove includes)
      block:
        - name: Block extra configs
          ansible.builtin.replace:
            path: /etc/sudoers
            regexp: '^@(includedir\s+\/etc\/sudoers.d)'
            replace: '#\1'
        - name: Block sudo for admin group
          ansible.builtin.replace:
            path: /etc/sudoers
            regexp: '^(%admin\s+ALL=\(ALL\)\s+ALL)'
            replace: '#\1'
        - name: Enable NOPASSWD for sudo group
          ansible.builtin.replace:
            path: /etc/sudoers
            regexp: '^(%sudo\s+ALL=\(ALL:ALL\)\s+)(ALL)'
            replace: '\1NOPASSWD:\2'

    - name: Disable root login shell
      ansible.builtin.replace:
        path: /etc/passwd
        regexp: '^root:(([^:]*:){5})\/bin\/bash\n'
        replace: 'root:\1/usr/sbin/nologin'

    - name: Confgure /etc/ssh/sshd_config
      block:
        - name: Change ssh default port
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?Port '
            line: "Port {{ ans_normal_port }}"
        - name: Disable root login
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitRootLogin '
            line: 'PermitRootLogin no'
        - name: Disable password authentication
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PasswordAuthentication '
            line: 'PasswordAuthentication no'
        - name: Disable empty passwords
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitEmptyPasswords '
            line: 'PermitEmptyPasswords no'
        - name: Enforce public key authentication
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PubkeyAuthentication '
            line: 'PubkeyAuthentication yes'

    - name: Restart SSH
      block:
        - name: Reload systemd daemon
          ansible.builtin.systemd:
            daemon_reload: true
        - name: Restart SSH socket and service
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: restarted
          loop:
            - ssh.socket
            - ssh.service

    - name: Install UFW and Fail2ban
      ansible.builtin.apt:
        name:
          - ufw
          - fail2ban
        state: present
        update_cache: true

    - name: Configure UFW firewall
      block:
        - name: Set default incoming policy to deny # noqa syntax-check[unknown-module]
          community.general.ufw:
            direction: incoming
            policy: deny

        - name: Set default outgoing policy to allow
          community.general.ufw:
            direction: outgoing
            policy: allow

        - name: Allow SSH on custom port
          community.general.ufw:
            rule: allow
            port: "{{ ans_normal_port }}"
            proto: tcp

        - name: Enable UFW
          community.general.ufw:
            state: enabled

    - name: Minimal host security configured
      ansible.builtin.debug:
        msg: |
          âœ… Security successfuly configured!
